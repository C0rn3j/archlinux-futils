#!/usr/bin/python
import pyalpm
import requests
import sys

pkg = sys.argv[1]
name_preset = requests.get("https://github.com/berberman/arch-hs/raw/master/data/NAME_PRESET.json").json()
reversed_name_preset = {v: k for k, v in name_preset.items()}

archpkg = reversed_name_preset[pkg] if pkg in reversed_name_preset else f"haskell-{pkg}"

handle = pyalpm.Handle(".", "/var/lib/pacman")

rdeps = set()

for db in ["community"]:
    db_handle = handle.register_syncdb(db, 0)
    for package in db_handle.search(""):
        for field in ("depends", "makedepends", "checkdepends"):
            if archpkg in getattr(package, field):
                rdeps.add((package.name, package.version.split("-")[0]))

for rdep, ver in rdeps:
    print(f"Extracting {rdep}...")
    hackage_name = name_preset[rdep] if rdep in name_preset else rdep[8:]
    cabal = requests.get(f"https://hackage.haskell.org/package/{hackage_name}-{ver}/revision/0.cabal").text
    for line in cabal.splitlines():
        if pkg in line:
            print(line)
        # if line.strip().startswith("build-depends:"):
        #     for dep in line.split(":")[1].split(","):
        #         dep = dep.strip()
        #         if dep.startswith("base"):
        #             continue
        #         print(dep.split(" ")[0])
